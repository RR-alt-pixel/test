<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SherLOCK CRM Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
        }
        h1 {
            text-align: center;
            font-weight: 600;
            margin-top: 10px;
        }
        p {
            margin: 5px 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 10px;
            background-color: var(--tg-theme-secondary-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            color: var(--tg-theme-text-color);
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #666;
        }
        .result, .error, .queue {
            white-space: pre-wrap;
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
        }
        .error {
            color: var(--tg-theme-destructive-text-color);
            border: 1px solid var(--tg-theme-destructive-text-color);
        }
        .queue {
            color: var(--tg-theme-hint-color);
            text-align: center;
            font-style: italic;
        }
        #footer {
            text-align: center;
            margin-top: 25px;
            font-size: 12px;
            color: var(--tg-theme-hint-color);
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Hogwarts</h1>
        <p>Введите данные для поиска:</p>
        <input type="text" id="queryInput" placeholder="ИИН, ФИО или номер телефона">
        <button id="searchButton">ИСКАТЬ</button>
        <div id="queueStatus" class="queue"></div>
        <div id="resultOutput" class="result">Здесь появится результат.</div>
    </div>

    <div id="footer">@harryyyy_potter_bot</div>

    <script>
        const API_BASE_URL = "https://test-2-tkqp.onrender.com"; // твой API Render

        const queryInput = document.getElementById('queryInput');
        const searchButton = document.getElementById('searchButton');
        const resultOutput = document.getElementById('resultOutput');
        const queueStatus = document.getElementById('queueStatus');

        let pollingInterval = null;
        let lastQuery = null;
        let lastClickTime = 0;
        const COOLDOWN_MS = 10000; // 10 секунд защита от спама

        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        async function checkQueueSize() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/queue-size`);
                const data = await res.json();
                if (data.queue_size !== undefined) {
                    queueStatus.innerText = `⏳ В очереди сейчас: ${data.queue_size}`;
                }
            } catch (err) {
                console.warn('Ошибка при обновлении очереди', err);
            }
        }

        async function sendSearch() {
            const query = queryInput.value.trim();
            const now = Date.now();

            // Антиспам: защита от повторов одного запроса
            if (query === lastQuery && now - lastClickTime < COOLDOWN_MS) {
                const waitSec = Math.ceil((COOLDOWN_MS - (now - lastClickTime)) / 1000);
                resultOutput.className = 'queue';
                resultOutput.innerText = `⚠️ Подождите ${waitSec} сек перед повторным запросом.`;
                return;
            }
            lastQuery = query;
            lastClickTime = now;

            if (!query) {
                resultOutput.className = 'error';
                resultOutput.innerText = 'Введите запрос.';
                return;
            }

            let userId = null;
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                userId = Telegram.WebApp.initDataUnsafe.user.id;
            }

            if (!userId) {
                resultOutput.className = 'error';
                resultOutput.innerText = 'Ошибка авторизации: не удалось получить ваш ID Telegram.';
                return;
            }

            // блокировка кнопки
            searchButton.disabled = true;
            resultOutput.className = 'result';
            resultOutput.innerText = '⌛ Отправка запроса...';
            queueStatus.innerText = '';

            // обновление очереди каждые 2,5 секунды
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(checkQueueSize, 2500);

            try {
                const response = await fetch(`${API_BASE_URL}/api/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        telegram_user_id: userId
                    })
                });

                const data = await response.json();
                clearInterval(pollingInterval);
                queueStatus.innerText = '';

                if (response.ok) {
                    resultOutput.className = 'result';
                    resultOutput.innerHTML = data.result;
                } else {
                    resultOutput.className = 'error';
                    resultOutput.innerText = `❌ ${data.error || 'Ошибка сервера'}`;
                }
            } catch (error) {
                clearInterval(pollingInterval);
                resultOutput.className = 'error';
                resultOutput.innerText = '❌ Ошибка соединения с сервером.';
            } finally {
                // задержка перед повторным включением кнопки
                setTimeout(() => { searchButton.disabled = false; }, 1500);
            }
        }

        searchButton.addEventListener('click', sendSearch);
    </script>
</body>
</html>
