<!DOCTYPE html>
<html lang="ru">
<head>
    <title>CRM Search Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* (–û—Å—Ç–∞–≤—å—Ç–µ —Å—Ç–∏–ª–∏ –∏–∑ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞ image_cd8147.png –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 10px;
            background-color: var(--tg-theme-secondary-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            color: var(--tg-theme-text-color);
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .result {
            white-space: pre-wrap;
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            color: var(--tg-theme-text-color);
            font-size: 14px;
        }
        .error {
            color: var(--tg-theme-destructive-text-color);
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>CRM –ü–æ–∏—Å–∫</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ –ò–ò–ù, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –§–ò–û...</p>
        <input type="text" id="queryInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ">
        <button id="searchButton">–ò–°–ö–ê–¢–¨</button>
        <div id="resultOutput" class="result">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
    </div>

    <script>
        // üü¢ –ê–î–†–ï–° –í–ê–®–ï–ì–û BACKEND (API) –ù–ê RENDER.COM
        const API_BASE_URL = "https://test-vk44.onrender.com"; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –≤–∞—à —Ç–æ—á–Ω—ã–π URL
        
        const queryInput = document.getElementById('queryInput');
        const searchButton = document.getElementById('searchButton');
        const resultOutput = document.getElementById('resultOutput');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mini App (–¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–æ–≤ –∏ –∑–∞–∫—Ä—ã—Ç–∏—è)
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        searchButton.addEventListener('click', async () => {
            const query = queryInput.value.trim();
            if (!query) {
                resultOutput.className = 'error';
                resultOutput.innerHTML = '–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.';
                return;
            }

            // üü¢ –ë–õ–û–ö –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
            let userId = null;
            if (window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                userId = Telegram.WebApp.initDataUnsafe.user.id;
            } else {
                resultOutput.className = 'error';
                resultOutput.innerHTML = '–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.';
                return;
            }

            resultOutput.className = 'result';
            resultOutput.innerHTML = '–ü–æ–∏—Å–∫...';
            searchButton.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        // üü¢ –û–¢–ü–†–ê–í–õ–Ø–ï–ú ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í API
                        telegram_user_id: userId 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                    resultOutput.className = 'result';
                    resultOutput.innerHTML = data.result;
                } else if (response.status === 403) {
                    // –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (–æ—Ç –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞, –µ—Å–ª–∏ –Ω–µ—Ç –≤ ALLOWED_USER_IDS)
                    resultOutput.className = 'error';
                    resultOutput.innerHTML = `‚ùå ${data.error || '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é.'}`;
                } else {
                    // –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ (–æ—à–∏–±–∫–∞ CRM, 500 –∏ —Ç.–¥.)
                    resultOutput.className = 'error';
                    resultOutput.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}`;
                }

            } catch (error) {
                // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ CORS
                resultOutput.className = 'error';
                resultOutput.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞: Failed to fetch';
                console.error('Fetch error:', error);
            } finally {
                searchButton.disabled = false;
            }
        });
    </script>
</body>
</html>
