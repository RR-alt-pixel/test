<!DOCTYPE html>
<html lang="ru">
<head>
    <title>CRM Search Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* CSS —Å—Ç–∏–ª–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è Mini App */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 10px;
            background-color: var(--tg-theme-secondary-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            color: var(--tg-theme-text-color);
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .result {
            white-space: pre-wrap;
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            color: var(--tg-theme-text-color);
            font-size: 14px;
        }
        .error {
            color: var(--tg-theme-destructive-text-color);
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            /* –í—ã–¥–µ–ª—è–µ–º –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É */
            border: 1px solid var(--tg-theme-destructive-text-color); 
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Sherlock</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ —Å—é–¥–∞.</p>
        <input type="text" id="queryInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ">
        <button id="searchButton">–ò–°–ö–ê–¢–¨</button>
        <div id="resultOutput" class="result">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
    </div>

    <script>
        // üõë –£–ë–ï–î–ò–¢–ï–°–¨, –ß–¢–û –≠–¢–û –¢–û–ß–ù–´–ô –ê–î–†–ï–° –í–ê–®–ï–ì–û BACKEND (API) –ù–ê RENDER.COM
        const API_BASE_URL = "https://test-vk44.onrender.com"; 
        
        const queryInput = document.getElementById('queryInput');
        const searchButton = document.getElementById('searchButton');
        const resultOutput = document.getElementById('resultOutput');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mini App
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        searchButton.addEventListener('click', async () => {
            const query = queryInput.value.trim();
            if (!query) {
                resultOutput.className = 'error';
                resultOutput.innerHTML = '–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.';
                return;
            }

            // üü¢ –ë–õ–û–ö –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ò–ó –î–ê–ù–ù–´–• TELEGRAM
            let userId = null;
            if (window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫—Ä—ã–ª Mini App
                userId = Telegram.WebApp.initDataUnsafe.user.id;
            } 
            
            if (userId === null) {
                // –ï—Å–ª–∏ ID –Ω–µ –ø–æ–ª—É—á–µ–Ω (—á—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º Telegram), –±–ª–æ–∫–∏—Ä—É–µ–º
                resultOutput.className = 'error';
                resultOutput.innerHTML = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à ID Telegram.';
                return;
            }

            resultOutput.className = 'result';
            resultOutput.innerHTML = '–ü–æ–∏—Å–∫...';
            searchButton.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        // üü¢ –û–¢–ü–†–ê–í–õ–Ø–ï–ú ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í API –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –î–û–°–¢–£–ü–ê
                        telegram_user_id: userId 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                    resultOutput.className = 'result';
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å HTML-—Ç–µ–≥–∏ <b>
                    resultOutput.innerHTML = data.result; 
                } else if (response.status === 403) {
                    // üõë –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–ö–ò –î–û–°–¢–£–ü–ê (403 Forbidden)
                    resultOutput.className = 'error';
                    resultOutput.innerHTML = `‚ùå –î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù: ${data.error || '–£ –≤–∞—Å –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.'}`;
                } else {
                    // –û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ (–æ—à–∏–±–∫–∞ CRM, 500 –∏ —Ç.–¥.)
                    resultOutput.className = 'error';
                    resultOutput.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}`;
                }

            } catch (error) {
                // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ CORS
                resultOutput.className = 'error';
                resultOutput.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å API.';
                console.error('Fetch error:', error);
            } finally {
                searchButton.disabled = false;
            }
        });
    </script>
</body>
</html>
